# 🔄 سير عمل Firebase والإشعارات - مخطط تفصيلي

## 📊 مخطط سير العمل الكامل

```
┌─────────────────────────────────────────────────────────────────┐
│                    بدء التطبيق (App Start)                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. تهيئة Firebase (lib/firebase.ts)                            │
│     - initializeApp(firebaseConfig)                             │
│     - getMessaging(app)                                         │
│     - getAnalytics(app)                                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. تسجيل Service Worker                                        │
│     (ForegroundNotificationListenerProvider)                     │
│     - فحص دعم المتصفح                                           │
│     - navigator.serviceWorker.register('/firebase-messaging-sw')│
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. طلب إذن الإشعارات                                           │
│     (في login.tsx أو useFirebaseMessaging)                      │
│     - Notification.requestPermission()                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │                   │
              granted              denied/default
                    │                   │
                    ▼                   ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. الحصول على FCM Token                                        │
│     - getToken(messaging, { vapidKey })                         │
│     - Token فريد لكل جهاز                                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. إرسال Token إلى الخادم                                      │
│     POST /api/fcm-token                                          │
│     { token: "fcm_token_here" }                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. حفظ Token في قاعدة البيانات                                │
│     (لإرسال الإشعارات لاحقاً)                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔔 استقبال الإشعارات

### السيناريو 1: التطبيق في المقدمة (Foreground)

```
┌─────────────────────────────────────────────────────────────────┐
│  الخادم يرسل إشعار عبر FCM                                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Firebase SDK يستقبل الإشعار                                    │
│  onMessage(messaging, callback)                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  useFirebaseMessaging Hook                                      │
│  - dispatch(fetchNotifications())                                │
│  - toast.success()                                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  تحديث UI                                                       │
│  - تحديث عداد الإشعارات                                         │
│  - إضافة الإشعار إلى القائمة                                    │
└─────────────────────────────────────────────────────────────────┘
```

### السيناريو 2: التطبيق في الخلفية (Background)

```
┌─────────────────────────────────────────────────────────────────┐
│  الخادم يرسل إشعار عبر FCM                                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Service Worker يستقبل الإشعار                                  │
│  (firebase-messaging-sw.js)                                      │
│  messaging.onBackgroundMessage()                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  عرض Native Notification                                        │
│  self.registration.showNotification()                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  المستخدم ينقر على الإشعار                                      │
│  notificationclick event                                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  فتح التطبيق                                                    │
│  clients.openWindow('/dashboard')                               │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🏗️ البنية المعمارية

```
┌─────────────────────────────────────────────────────────────────┐
│                        Client Side                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  React Components                                         │  │
│  │  - NotificationBell                                       │  │
│  │  - ForegroundNotificationListener                         │  │
│  └──────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Custom Hooks                                            │  │
│  │  - useFirebaseMessaging()                                │  │
│  └──────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Firebase SDK                                            │  │
│  │  - lib/firebase.ts                                       │  │
│  │  - kit/firebase.ts                                       │  │
│  └──────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Service Worker                                          │  │
│  │  - firebase-messaging-sw.js                              │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP/HTTPS
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Server Side                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  API Routes                                              │  │
│  │  - POST /api/fcm-token (حفظ Token)                      │  │
│  │  - DELETE /api/fcm-token (حذف Token)                    │  │
│  └──────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Database                                                │  │
│  │  - حفظ FCM Tokens                                        │  │
│  │  - ربط Tokens بالمستخدمين                                │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ FCM API
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Firebase Cloud Messaging                     │
│                    (Google's FCM Service)                        │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 دورة حياة FCM Token

```
┌─────────────────────────────────────────────────────────────────┐
│  1. إنشاء Token                                                  │
│     - عند طلب الإذن والحصول عليه                                 │
│     - Token فريد لكل جهاز ومتصفح                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. حفظ Token                                                    │
│     - في localStorage (اختياري)                                 │
│     - في قاعدة البيانات (عبر API)                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. استخدام Token                                               │
│     - الخادم يستخدمه لإرسال الإشعارات                           │
│     - يمكن إرسال إشعارات مستهدفة                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. تحديث Token                                                 │
│     - Firebase قد يحدث Token تلقائياً                           │
│     - يجب إعادة إرسال Token المحدث                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. حذف Token                                                   │
│     - عند تسجيل الخروج                                          │
│     - عند إلغاء تفعيل الإشعارات                                 │
│     - deleteToken(messaging)                                    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎯 حالات الاستخدام

### 1. إشعار حجز جديد

```
المستخدم (المضيف) ←──┐
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  الخادم يكتشف حجز جديد                                          │
│  - استعلام قاعدة البيانات                                       │
│  - تحديد FCM Token للمضيف                                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  إرسال إشعار عبر FCM                                            │
│  POST https://fcm.googleapis.com/fcm/send                       │
│  {                                                              │
│    "to": "fcm_token_here",                                      │
│    "notification": {                                            │
│      "title": "حجز جديد",                                      │
│      "body": "لديك حجز جديد في مكان الإقامة"                   │
│    }                                                            │
│  }                                                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Firebase يرسل الإشعار للجهاز                                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │                   │
            App in Foreground    App in Background
                    │                   │
                    ▼                   ▼
        ┌──────────────────┐  ┌──────────────────┐
        │ Toast + Redux    │  │ Native Notification
        │ Update           │  │ (Service Worker)
        └──────────────────┘  └──────────────────┘
```

### 2. إشعار رسالة جديدة

```
المستخدم (الضيف) ←──┐
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│  الخادم يكتشف رسالة جديدة                                       │
│  - WebSocket أو Polling                                         │
│  - تحديد FCM Token للمستقبل                                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  إرسال إشعار عبر FCM                                            │
│  {                                                              │
│    "to": "fcm_token_here",                                      │
│    "notification": {                                            │
│      "title": "رسالة جديدة",                                   │
│      "body": "لديك رسالة من المضيف"                            │
│    },                                                           │
│    "data": {                                                    │
│      "type": "message",                                        │
│      "chatId": "123"                                            │
│    }                                                            │
│  }                                                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  عند النقر على الإشعار:                                         │
│  - فتح التطبيق                                                 │
│  - الانتقال إلى صفحة المحادثة                                  │
│  - clients.openWindow('/chat/123')                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🛠️ خطوات التطبيق

### الخطوة 1: إعداد Firebase Console

1. إنشاء مشروع Firebase
2. تفعيل Cloud Messaging
3. الحصول على VAPID Key
4. إضافة Web App

### الخطوة 2: إعداد البيئة

```env
# .env.local
NEXT_PUBLIC_FIREBASE_API_KEY=...
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=...
NEXT_PUBLIC_FIREBASE_PROJECT_ID=...
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=...
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=...
NEXT_PUBLIC_FIREBASE_APP_ID=...
NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=...
NEXT_PUBLIC_FIREBASE_VAPID_KEY=...  # مهم جداً!
```

### الخطوة 3: تثبيت الحزم

```bash
pnpm add firebase
```

### الخطوة 4: إنشاء الملفات

1. `lib/firebase.ts` - تهيئة Firebase
2. `public/firebase-messaging-sw.js` - Service Worker
3. `hooks/useFirebaseMessaging.ts` - Custom Hook
4. `app/api/fcm-token/route.ts` - API Endpoint

### الخطوة 5: التكامل في التطبيق

1. إضافة `ForegroundNotificationListenerProvider` في Layout
2. استخدام `useFirebaseMessaging` في صفحات تسجيل الدخول
3. إضافة `NotificationBell` في Header

---

## ✅ Checklist

- [ ] Firebase مشروع تم إنشاؤه
- [ ] VAPID Key تم الحصول عليه
- [ ] متغيرات البيئة تم إعدادها
- [ ] Service Worker تم إنشاؤه
- [ ] API Endpoint يعمل
- [ ] Hook مخصص تم إنشاؤه
- [ ] المكونات تم إضافتها
- [ ] الاختبار على متصفحات مختلفة
- [ ] الاختبار على أجهزة مختلفة
- [ ] معالجة الأخطاء تمت

---

## 📝 ملاحظات مهمة

1. **HTTPS مطلوب**: Service Workers تعمل فقط على HTTPS (أو localhost)
2. **VAPID Key ضروري**: بدون VAPID Key لن تعمل الإشعارات
3. **دعم المتصفح**: بعض المتصفحات (مثل Instagram WebView) لا تدعم Service Workers
4. **Token Management**: يجب إدارة Tokens بشكل صحيح (حفظ/حذف/تحديث)
5. **Privacy**: يجب طلب الإذن بشكل مناسب وليس بشكل مزعج

---

تم إنشاء هذا الملف بواسطة Auto AI Assistant 🚀

